from elliptic_curves.instantiations.bls12_381.bls12_381 import bls12_381, Fq12, Fq, Fq2, Fr, BLS12_381, BLS12_381_Twist
from data_for_tests import serialised_vk, serialised_proof

g1 = bls12_381.g1
g2 = bls12_381.g2

pairing_g1_g2_serialised = [182, 137, 23, 202, 170, 5, 67, 168, 8, 197, 57, 8, 246, 148, 209, 182, 231, 179, 141, 233, 12, 233, 216, 61, 80, 92, 161, 239, 27, 68, 45, 39, 39, 215, 208, 104, 49, 216, 178, 167, 146, 10, 252, 113, 216, 235, 80, 18, 15, 23, 160, 234, 152, 42, 136, 89, 29, 159, 67, 80, 62, 148, 168, 241, 171, 175, 46, 69, 137, 246, 90, 175, 183, 146, 60, 72, 69, 64, 168, 104, 136, 52, 50, 165, 198, 14, 117, 134, 11, 17, 229, 70, 91, 28, 154, 8, 135, 62, 194, 158, 132, 76, 28, 136, 140, 179, 150, 147, 48, 87, 255, 221, 84, 27, 3, 165, 34, 14, 218, 22, 178, 179, 166, 114, 142, 166, 120, 3, 76, 227, 156, 104, 57, 242, 3, 151, 32, 45, 124, 92, 68, 187, 104, 19, 79, 147, 25, 60, 236, 33, 80, 49, 177, 115, 153, 87, 122, 29, 229, 255, 31, 91, 6, 102, 189, 216, 144, 124, 97, 167, 101, 30, 78, 121, 224, 55, 41, 81, 80, 90, 7, 250, 115, 194, 87, 136, 219, 110, 184, 2, 53, 25, 165, 170, 151, 181, 31, 28, 173, 29, 67, 216, 170, 187, 255, 77, 195, 25, 199, 154, 88, 202, 252, 3, 82, 24, 116, 124, 47, 117, 218, 248, 242, 251, 124, 0, 196, 77, 168, 91, 18, 145, 19, 23, 61, 71, 34, 245, 178, 1, 182, 180, 69, 64, 98, 233, 234, 139, 167, 140, 92, 163, 202, 218, 247, 35, 139, 71, 186, 206, 92, 229, 97, 128, 74, 225, 107, 143, 75, 99, 218, 70, 69, 184, 69, 122, 147, 121, 60, 189, 100, 167, 37, 79, 21, 7, 129, 1, 157, 232, 126, 228, 38, 130, 148, 15, 62, 112, 168, 134, 131, 213, 18, 187, 44, 63, 183, 178, 67, 77, 165, 222, 219, 178, 208, 179, 251, 132, 135, 200, 77, 160, 213, 195, 21, 189, 214, 156, 70, 251, 5, 210, 55, 99, 242, 25, 26, 171, 213, 213, 194, 225, 42, 16, 184, 240, 2, 255, 104, 27, 253, 27, 46, 224, 191, 97, 157, 128, 210, 167, 149, 235, 34, 242, 170, 123, 133, 213, 255, 182, 113, 167, 12, 148, 128, 159, 13, 175, 197, 183, 62, 162, 251, 6, 87, 186, 226, 51, 115, 180, 147, 27, 201, 250, 50, 30, 136, 72, 239, 120, 137, 78, 152, 123, 255, 21, 13, 125, 103, 26, 238, 48, 179, 147, 26, 200, 197, 14, 11, 59, 8, 104, 239, 252, 56, 191, 72, 205, 36, 180, 184, 17, 162, 153, 90, 194, 160, 145, 34, 190, 217, 253, 159, 160, 197, 16, 168, 123, 16, 41, 8, 54, 173, 6, 200, 32, 51, 151, 181, 106, 120, 233, 160, 198, 28, 119, 229, 108, 203, 79, 27, 195, 211, 252, 174, 167, 85, 15, 53, 3, 239, 227, 15, 45, 36, 240, 8, 145, 203, 69, 98, 6, 5, 252, 250, 164, 41, 38, 135, 179, 167, 219, 124, 28, 5, 84, 169, 53, 121, 232, 137, 161, 33, 253, 143, 114, 100, 155, 36, 2, 153, 106, 8, 77, 35, 129, 197, 4, 49, 102, 103, 59, 56, 73, 228, 253, 30, 126, 228, 175, 36, 170, 142, 212, 67, 245, 109, 253, 107, 104, 255, 222, 68, 53, 169, 44, 215, 164, 172, 59, 199, 126, 26, 208, 203, 114, 134, 6, 207, 8, 191, 99, 134, 229, 65, 15]
pairing_g1_g2 = Fq12.deserialise(pairing_g1_g2_serialised)

def test_pairing() -> bool:
    miller_output_twisted_curve = bls12_381.miller_loop_on_twisted_curve(g1,g2,'quadratic')

    pairing_base_curve = bls12_381.pairing(g1,g2)
    pairing_twisted_curve = miller_output_twisted_curve.power(3*(bls12_381.q**12-1)//bls12_381.r)

    assert(pairing_base_curve == pairing_g1_g2)
    assert(pairing_base_curve == pairing_twisted_curve)

    for i in range(5):
        l = Fr.generate_random_point().x
        assert(bls12_381.pairing(g1.multiply(l),g2) == pairing_base_curve.power(l))
        assert(bls12_381.pairing(g1,g2.multiply(l)) == pairing_base_curve.power(l))
    
    return True

def test_triple_pairing() -> bool:
    P1 = g1
    P2 = g1
    P3 = g1
    Q1 = g2
    Q2 = g2
    Q3 = g2

    triple_pairing = bls12_381.triple_pairing(P1,P2,P3,Q1,Q2,Q3)
    return triple_pairing == pairing_g1_g2.power(3)

def test_deserialisation() -> bool:
    # 151 & (1 << 7) = 128 => Testing largest y
    serialised_point = [31, 28, 104, 58, 214, 230, 251, 140, 108, 133, 193, 237, 1, 216, 231, 231, 155, 5, 133, 235, 18, 220, 209, 212, 203, 63, 62, 143, 144, 60, 31, 75, 249, 184, 224, 109, 197, 76, 189, 229, 228, 166, 24, 239, 5, 183, 145, 1, 204, 242, 43, 33, 236, 146, 143, 238, 176, 169, 155, 46, 28, 178, 38, 164, 65, 163, 100, 209, 92, 174, 48, 126, 67, 78, 253, 164, 222, 219, 122, 82, 255, 8, 75, 215, 45, 186, 68, 234, 206, 27, 40, 145, 219, 72, 33, 151]
    point = BLS12_381(Fq(241521825108085326152546143885075698096242717769365851673777146265962830024243722276743782280873588223519920495647),
                      Fq(3560035591319159527750795167323375962990500740637199979279756662028071590138066280420930564248685402405154128130764)
                      )
    assert(point == BLS12_381.deserialise(serialised=serialised_point,field=Fq))

    serialised_g1 = [187, 198, 34, 219, 10, 240, 58, 251, 239, 26, 122, 249, 63, 232, 85, 108, 88, 172, 27, 23, 63, 58, 78, 161, 5, 185, 116, 151, 79, 140, 104, 195, 15, 172, 169, 79, 140, 99, 149, 38, 148, 215, 151, 49, 167, 211, 241, 23, 225, 231, 197, 70, 41, 35, 170, 12, 228, 138, 136, 162, 68, 199, 60, 208, 237, 179, 4, 44, 203, 24, 219, 0, 246, 10, 208, 213, 149, 224, 245, 252, 228, 138, 29, 116, 237, 48, 158, 160, 241, 160, 170, 227, 129, 244, 179, 8]
    assert(g1 == BLS12_381.deserialise(serialised_g1,Fq))

    serialised_point = [184, 189, 33, 193, 200, 86, 128, 212, 239, 187, 5, 168, 38, 3, 172, 11, 119, 209, 227, 122, 100, 11, 81, 180, 2, 59, 64, 250, 212, 122, 228, 198, 81, 16, 197, 45, 39, 5, 8, 38, 145, 10, 143, 240, 178, 162, 74, 2, 126, 43, 4, 93, 5, 125, 172, 229, 87, 93, 148, 19, 18, 241, 76, 51, 73, 80, 127, 220, 187, 97, 218, 181, 26, 182, 32, 153, 208, 208, 107, 89, 101, 79, 39, 136, 160, 211, 172, 125, 96, 159, 113, 82, 96, 43, 224, 19, 1, 40, 184, 8, 134, 84, 147, 225, 137, 162, 172, 59, 204, 201, 58, 146, 44, 209, 96, 81, 105, 154, 66, 109, 167, 211, 189, 140, 170, 155, 253, 173, 26, 53, 46, 218, 198, 205, 201, 140, 17, 110, 125, 114, 39, 213, 229, 12, 190, 121, 95, 240, 95, 7, 169, 170, 161, 29, 236, 92, 39, 13, 55, 63, 171, 153, 46, 87, 171, 146, 116, 38, 175, 99, 167, 133, 126, 40, 62, 203, 153, 139, 194, 43, 176, 210, 172, 50, 204, 52, 167, 46, 160, 196, 6, 6]
    point = BLS12_381_Twist(
        x=Fq2(
            Fq(352701069587466618187139116011060144890029952792775240219908644239793785735715026873347600343865175952761926303160),
            Fq(3059144344244213709971259814753781636986470325476647558659373206291635324768958432433509563104347017837885763365758)
            ),
        y=Fq2(
            Fq(1985150602287291935568054521177171638300868978215655730859378665066344726373823718423869104263333984641494340347905),
            Fq(927553665492332455747201965776037880757740193453592970025027978793976877002675564980949289727957565575433344219582)
        )
    )
    assert(point == BLS12_381_Twist.deserialise(serialised_point,Fq2))

    return True

def test_deserialisation_vk() -> bool:
    # Deserialisation of single points are correct, we only need to ensure that the whole key is deserialised as it should be
    vk = bls12_381.deserialise_vk(serialised=serialised_vk)
    assert(len(vk) == 5)
    
    return True

def test_deserialisation_proof() -> bool:
    # Deserialisation of single points are correct, we only need to ensure that the whole proof is deserialised as it should be
    proof = bls12_381.deserialise_proof(serialised=serialised_proof)
    assert(len(proof) == 3)

    return True


assert(test_pairing())
assert(test_triple_pairing())
assert(test_deserialisation())
assert(test_deserialisation_vk())
assert(test_deserialisation_proof())

print("BLS12_381: all tests successful")

